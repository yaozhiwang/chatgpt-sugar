= Message Statistics Calculation
:table-caption!:

This document describes how we calculate the message statistics.

We refer a `Conversation` as a chat or a session, which you can find listed in the sidebar of ChatGPT.
To calculate the statistics, we first retrieve the list of conversations.
Then, for each conversation, we scan all the messages within it to compute the stats.

Unlike `Conversation`, defining the different types of messages is not as intuitive.
Each conversation consists of multiple turns of messages between the user and the assistant:
the user sends a message, and the assistant replies.
The complexity arises because, behind every turn, ChatGPT may send several internal messages using its tools.
As a result, the message list in a conversation often contains many more messages than what we see in the UI.

[NOTE]
====
For the most accurate and up-to-date information on the calculations,
please refer to the https://github.com/yaozhiwang/chatgpt-sugar/blob/master/src/content-script/chatgpt-journey/data.ts[source code].
====

== Total Messages

Messages sent by users are identified by `author.role == "user"`.
We sum all these messages to calculate the `Total Messages`, which includes both `GPT-3.5` and `GPT-4 Messages`.

For each message where `author.role == "assistant"`, the `end_turn` property indicates the completion of a turn,
and the `model_slug` property specifies the model used.
Using this information, we count `GPT-4 Messages` as the number of assistant messages
where `end_turn == true` and `model_slug == "gpt-4"`.
Finally, subtracting `GPT-4 Messages` from `Total Messages` gives us the count of `GPT-3.5 Messages`.

== Vision, Voice and File Messages

`Vision`, `Voice` and `File` messages are calculated from user messages as follows:

[cols="^.^1,<.^2"]
|===
| Type | Rule

| Vision | content.content_type == "multimodal_text"
| Voice  | metadata.voice_mode_message == true
| File   | metadata.attachments != null
|===

== Messages available for ChatGPT Plus

With ChatGPT Plus, users can do more than just text chat.

As mentioned earlier, ChatGPT may utilize various tools multiple times within a single turn.
We count this as one message for each tool that is called at least once.

Additionally, the final `end_turn` message is generated by GPT-4, incorporating information returned by the tools.
Therefore, this message is also counted as one GPT-4 Message.

=== Image Messages

.Message flow of an image creation
[cols="5*^.^"]
|===
| User |     | Assistant |         | Tool

|<start_turn>     e| →M1:"Create a logo for me" s| gpt-4      2.2+|
   2.2+|     e| ↓M2:"Creating a logo that ..."
             s| gpt-4     e| →M3:{"size":"1024x1024","prompt":"An image for ..."}  .3+s| dalle.text2im
.2+|<end_turn>      .2+e| ←M6:"Here is a conceptual logo for..."         .2+s| gpt-4     e| ←M4:image_url
                          e| ←M5:"\nDALL·E displayed 1 images. The images are already plainly visible..."
|===

.Properties of message sent by GPT-4
[cols="5*^.^"]
|===
| ID | content_type | recipient | end_turn | model_slug

| M2 | text | all | false | gpt-4
| M3 | code | dalle.text2im | false | gpt-4
| M6 | text | all | true | gpt-4
|===

.Properties of message sent by DALL·E
[cols="4*^.^"]
|===
| ID | name | content_type | recipient

| M4 | dalle.text2im | multimodal_text | all
| M5 | dalle.text2im | text | all
|===


=== Web Browser Messages

=== Message flow of a web browser `open_url` message
[cols="5*^.^"]
|===
| User |     | Assistant |         | Tool

|<start_turn>     e| →M1:"Check out https://..." .5+s| gpt-4 e| →M2:open_url("https://...")  .4+s| browser
2.2+|                                                        e| ←M3:result:"L0:...\nL1:...\n..."
                                                             e| →M4:quote_lines(120, 145)
|<end_turn>       e| ←M6:"This webpage is that..."           e| ←M5:{title:"...", url:"...", text:"..."}
|===

.Properties of message sent by GPT-4
[cols="5*^.^"]
|===
| ID | content_type | recipient | end_turn | model_slug

| M2 | code | browser | false | gpt-4
| M4 | code | browser | false | gpt-4
| M6 | text | all     | true  | gpt-4
|===

.Properties of message sent by browser
[cols="4*^.^"]
|===
| ID | name | content_type | recipient

| M3 | browser | tether_browsing_display | all
| M5 | browser | tether_quote | all
|===

=== Message flow of a web browser `search` message
[cols="5*^.^"]
|===
| User |     | Assistant |         | Tool

|<start_turn>     e| →M1:"who are this year's Oscar winners?" .11+s| gpt-4 e| →M2:search("who are...")  .11+s| browser
2.9+|                                                                      e| ←M3:<list of urls of search results>
                                                                           e| →M4:click(5)
                                                                           e| ←M5:result:"L0:...\nL1:...\n..."
                                                                           e| →M6:back()
                                                                           e| ←M7:<list of urls of search results>
                                                                           e| →M8:click(0)
                                                                           e| ←M9:result:"L0:...\nL1:...\n..."
                                                                           e| →M10:quote_lines(144, 146)\r\nquote_lines(148, 148)
                                                                           e| ←M11:<result of first quote>
|<end_turn>       e| ←M13:"Winners of 2023 Oscar..."                       e| ←M12:<result of second quote>
|===

.Properties of message sent by GPT-4
[cols="5*^.^"]
|===
| ID | content_type | recipient | end_turn | model_slug

| M2 | code | browser | false | gpt-4
| M4,M8 | code | browser | false | gpt-4
| M6 | code | browser  | false | gpt-4
| M10 | code | browser | false | gpt-4
| M13 | text | all     | true  | gpt-4
|===

.Properties of message sent by browser
[cols="4*^.^"]
|===
| ID | name | content_type | recipient

| M3,7 | browser | tether_browsing_display | all
| M5,9 | browser | tether_browsing_display | all
| M11 | browser | tether_quote | all
| M12 | browser | tether_quote | all
|===

=== Code Interepter Messages

.Message flow of an code interepter
[cols="5*^.^"]
|===
| User |     | Assistant |         | Tool

|<start_turn>     e| →M1:"what is 234 plus 1876" .2+s| gpt-4 e| →M2:<python code to get result>  .2+s| python
|<end_turn>       e| ←M4:"The sum of 234 and 1876 is 2110."  e| ←M3:2110
|===

.Properties of message sent by GPT-4
[cols="5*^.^"]
|===
| ID | content_type | recipient | end_turn | model_slug

| M2 | code | python | false | gpt-4
| M4 | text | all | true | gpt-4
|===

.Properties of message sent by python
[cols="4*^.^"]
|===
| ID | name | content_type | recipient

| M3 | python | execution_output | all
|===
